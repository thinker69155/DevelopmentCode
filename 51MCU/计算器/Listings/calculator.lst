C51 COMPILER V9.59.0.0   CALCULATOR                                                        12/09/2025 16:30:56 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE CALCULATOR
OBJECT MODULE PLACED IN .\Objects\calculator.obj
COMPILER INVOKED BY: D:\software\keil\C51\BIN\C51.EXE calculator.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\计算器) DEBUG OBJE
                    -CTEXTEND PRINT(.\Listings\calculator.lst) TABS(2) OBJECT(.\Objects\calculator.obj)

line level    source

   1          #include <string.h>
   2          #include "globalvars.h"
   3          #include "keyboard.h"
   4          #include <math.h>
   5          
   6          
   7          
   8          
   9          
  10          //////////////////////////////////////////////////////////////////////////
  11          
  12          
  13          // -------------------------- 工具函数 --------------------------
  14          //判断字符是否为数字（0-9）
  15          bit is_digit(unsigned char a) 
  16          {
  17   1          return (a >= '0' && a <= '9');
  18   1      }
  19          
  20          // 获取运算符优先级（数字越大优先级越高）
  21          unsigned char priority(char op) 
  22          {
  23   1          if (op == 's' || op == 'c' || op == 't') return 4;  // sin/cos/tan（用首字母代表）
  24   1          if (op == 'n') return 3;
  25   1          if (op == '*' || op == '/') return 2;
  26   1          if (op == '+' || op == '-') return 1;
  27   1          if (op == '(') return 0;
  28   1          return 0xFF;  // 无效运算符
  29   1      }
  30          
  31          // 二元运算符计算
  32          int calc_op(int a, int b, char op) 
  33          {
  34   1          switch(op) 
  35   1          {
  36   2              case '+': return a + b;
  37   2              case '-': return a - b;
  38   2              case '*': return a * b;
  39   2              case '/': return (b != 0) ? (a / b) : 0;  // 除数为0返回0
  40   2              case 'n': 
  41   2              {  // 幂运算（整数指数）            
  42   3                  int i=0;
  43   3                  int j= 1;
  44   3                  for( i=0; i<b; i++) 
  45   3                  j *= a;
  46   3                  return j;
  47   3              }
  48   2              default: return 0;
  49   2          }
  50   1      }
  51          
  52          //三角函数计算（参数为整数弧度，结果为整数）
  53          int angle(int a, char b) 
  54          {
C51 COMPILER V9.59.0.0   CALCULATOR                                                        12/09/2025 16:30:56 PAGE 2   

  55   1          switch(b) 
  56   1          {
  57   2              case 's': return (int)(sin((double)a) * 1000);  // 放大1000倍，保留精度
  58   2              case 'c': return (int)(cos((double)a) * 1000);
  59   2              case 't': return (int)(tan((double)a) * 1000);
  60   2              default: return 0;
  61   2          }
  62   1      }
  63          ///////////////////////////////////////////////////////////////////////////////////////////////////
  64          // -------------------------- 解析与计算函数 --------------------------
  65          
  66          // 解析正负整数：
  67          unsigned char to_int(const unsigned char** p, int* num)
  68            //num一级指针，指向储存的整合后的数字，p二级指针，指向字符串指针 
  69          {
  70   1          int sign;  
  71   1          *num = 0;
  72   1          sign = 1;  // 符号位（1=正，-1=负）
  73   1      
  74   1          if (**p == '-') 
  75   1          {
  76   2              sign = -1;
  77   2              (*p)++;//指针后移一位
  78   2      //        if (!is_digit(**p)) return 0;
  79   2          }
  80   1          // 连续数字拼接
  81   1          while (**p != '\0' && is_digit(**p)) 
  82   1          {
  83   2              *num = *num * 10 + (**p - '0');
  84   2              (*p)++;
  85   2          }
  86   1      
  87   1          *num = *num * sign;//填入正负号
  88   1          return 1;
  89   1      }
  90          
  91          // 主计算函数：所有局部变量提前到函数开头定义
  92          bit calculate(void) 
  93          {
  94   1          unsigned char num_i = 0, op_i = 0;      // 数字栈、运算符栈指针
  95   1          const unsigned char* p = expr;          // 字符串指针
  96   1          int num;                                // 存储解析后的数字
  97   1          int b, a;                               // a是左操作数，b是右操作数
  98   1          char current_op, top_op, op;            // 临时运算符（当前运算符、栈顶运算符）
  99   1      
 100   1          while (*p != '\0') 
 101   1          {
 102   2      //        if (*p == ' ') 
 103   2      //        { p++; continue; }
 104   2      
 105   2              // 解析数字
 106   2              if (is_digit(*p) || (*p == '-' && (p == expr || *(p-1) == '(' || priority(*(p-1)) != 0xFF))) 
 107   2              {
 108   3                  if (!to_int(&p, &num)) return 0;
 109   3      //            if (num_i >= STACK) return 0;
 110   3                  num_stack[num_i++] = num;
 111   3                  continue;
 112   3              }
 113   2              // 左括号
 114   2              if (*p == '(') 
 115   2              {
 116   3                  op_stack[op_i++] = *p;
C51 COMPILER V9.59.0.0   CALCULATOR                                                        12/09/2025 16:30:56 PAGE 3   

 117   3                  p++;
 118   3                  continue;
 119   3              }
 120   2      
 121   2              // 右括号：使用提前定义的变量b、a、op
 122   2              if (*p == ')') 
 123   2              {
 124   3                  while (op_i > 0 && op_stack[op_i-1] != '(') 
 125   3                  {
 126   4                      if (num_i < 2) return 0;
 127   4                      b = num_stack[--num_i];  
 128   4                      a = num_stack[--num_i];
 129   4                      op = op_stack[--op_i];
 130   4                      num_stack[num_i++] = calc_op(a, b, op);
 131   4                  }
 132   3                  if (op_i > 0 && (op_stack[op_i-1] == 's' || op_stack[op_i-1] == 'c' || op_stack[op_i-1] == 't')) 
 133   3                  {
 134   4                      // 三角函数是一元运算，只需1个参数
 135   4                  //    if (num_i < 1) return 0;
 136   4                      int x = num_stack[--num_i];  // 弹出参数（比如 1）
 137   4                      char angle_op = op_stack[--op_i]; // 弹出三角函数运算符（比如 't'）
 138   4                      num_stack[num_i++] = angle(x, angle_op); // 计算结果压回栈
 139   4                  }
 140   3      //            if (op_i == 0 || op_stack[op_i-1] != '(') return 0;
 141   3      //            op_i--;
 142   3      //            p++;
 143   3                  continue;
 144   3              }
 145   2      
 146   2              // 普通运算符：使用提前定义的变量current_op、top_op、b、a
 147   2              if (priority(*p) != 0xFF) 
 148   2              {
 149   3                  current_op = *p;
 150   3                  while (op_i > 0) 
 151   3                  {
 152   4                      top_op = op_stack[op_i-1];
 153   4                      if (top_op == '(') break;
 154   4      
 155   4                      if (priority(current_op) > priority(top_op) ||
 156   4                          (priority(current_op) == priority(top_op) && current_op == 'n')) 
 157   4                      {
 158   5                          break;
 159   5                      }
 160   4      
 161   4                      if (num_i < 2) return 0;
 162   4                      b = num_stack[--num_i];  // 直接使用提前定义的变量
 163   4                      a = num_stack[--num_i];
 164   4                      num_stack[num_i++] = calc_op(a, b, top_op);
 165   4                      op_i--;
 166   4                  }
 167   3                  if (op_i >= STACK) return 0;
 168   3                  op_stack[op_i++] = current_op;
 169   3                  p++;
 170   3                  continue;
 171   3              }
 172   2      
 173   2              return 0;
 174   2          }
 175   1      
 176   1          // 处理剩余运算符：使用提前定义的变量b、a、op
 177   1          while (op_i > 0) 
 178   1          {
C51 COMPILER V9.59.0.0   CALCULATOR                                                        12/09/2025 16:30:56 PAGE 4   

 179   2              if (op_stack[op_i-1] == '(') return 0;
 180   2              if (num_i < 2) return 0;
 181   2              b = num_stack[--num_i];  // 直接使用提前定义的变量
 182   2              a = num_stack[--num_i];
 183   2              op = op_stack[--op_i];
 184   2              num_stack[num_i++] = calc_op(a, b, op);
 185   2          }
 186   1      //    if (num_i != 1) return 0;
 187   1          result = num_stack[0];
 188   1          return 1;
 189   1      }
 190          ///////////////////////////////////////////////////////////////
 191          // -------------------------- 按键处理函数 --------------------------
 192          // 按键处理函数：拼接表达式、触发计算、清零
 193          void key_process(void) 
 194          {
 195   1          // 1. 清零功能（FN模式按'k'）
 196   1          if (get == 'k') 
 197   1          {
 198   2              memset(expr, 0, EXPR_LEN);  // 清空表达式缓冲区
 199   2              expr_i = 0;                 // 重置输入索引
 200   2              result = 0;                 // 重置结果
 201   2              get = 0;
 202   2              return;
 203   2          }
 204   1      
 205   1          // 2. 计算功能（普通模式按'='）
 206   1          if (get == '=') 
 207   1          {
 208   2              if (expr_i > 0) 
 209   2              {
 210   3                  if (calculate() == 0) 
 211   3                  {
 212   4                      // 计算失败（如表达式错误："10+"、"(123"），可添加错误提示
 213   4                      memset(expr, 0, EXPR_LEN);
 214   4                      expr_i = 0;
 215   4                      result = 0;
 216   4                  }
 217   3              }
 218   2              get = 0;
 219   2              return;
 220   2          }
 221   1      
 222   1          // 3. 拼接输入字符到表达式缓冲区
 223   1          if (get != 0 && expr_i + 1 < EXPR_LEN) 
 224   1          {  // get!=0 表示有效输入
 225   2              expr[expr_i++] = get;
 226   2              expr[expr_i] = '\0';  // 字符串结尾加'\0'，确保calculate能识别结束
 227   2          }
 228   1          get = 0;  // 重置输入，避免重复处理
 229   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1320    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      33
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.

C51 COMPILER V9.59.0.0   CALCULATOR                                                        12/09/2025 16:30:56 PAGE 5   


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
